---
title: "PHP Extension ã®ã¤ãã‚Šã‹ãŸ"
emoji: "ğŸ™„"
type: "tech"
topics: []
published: false
---

# PHP Extension ã¨ã¯
PHP Extension ã¯ãã®åã®é€šã‚Š PHP ã«è¿½åŠ ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãŸã‚ã®æ‹¡å¼µæ©Ÿèƒ½ã§ã™ã€‚
åŸºæœ¬çš„ã« C è¨€èªã§å®Ÿè£…ã•ã‚Œã‚‹ãŸã‚ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚„ãƒã‚·ãƒ³ã«å¯¾ã—ãƒã‚¤ãƒ†ã‚£ãƒ–ãªå‡¦ç†ã‚’æ¯”è¼ƒçš„å®¹æ˜“ã«å®Ÿè£…ã§ãã€å®Ÿè¡Œé€Ÿåº¦ã‚‚ PHP ã«æ¯”ã¹ã‚‹ã¨é«˜é€Ÿã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

ä¸€æ–¹ã§ã€ C è¨€èªã‚’åˆ©ç”¨ã™ã‚‹éƒ½åˆä¸Šã€ç¢ºä¿ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®ç®¡ç†ãŒæ‰‹å‹•ã§å®¹æ˜“ã«ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’èµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã€ã¾ãŸ PHP ã‚³ã‚¢ãŒæä¾›ã™ã‚‹ãƒã‚¯ãƒ­ã‚„é–¢æ•°ã«ã¤ã„ã¦ã‚ã‚‹ç¨‹åº¦ç†è§£ãŒå¿…è¦ã§ã™ã€‚

# PHP ã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹
ã¾ãšã¯ PHP ã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ç’°å¢ƒã‚’æ•´ãˆã¾ã™ã€‚ä»Šå›ã¯ Debian 10 Buster ã‚’åˆ©ç”¨ã—ã¦ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

## å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
`apt` ã‚’åˆ©ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªãƒ„ãƒ¼ãƒ«ãŠã‚ˆã³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ sudo apt-get update
$ sudo apt-get install -y build-essential autoconf re2c bison pkg-config valgrind zlib1g-dev libzip-dev libsqlite3-dev libxml2-dev libssl-dev
```

æœ€å°æ§‹æˆã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã«ã¯ä¸è¦ãªã‚‚ã® (`libxml` ç­‰) ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ‡ãƒãƒƒã‚°æ™‚ã«ä¸ä¾¿ãªã®ã§å…¥ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ãƒ¡ãƒ¢ãƒªå‘¨ã‚Šã®ãƒ‡ãƒãƒƒã‚°ã‚’è¡Œã†ãŸã‚ã«å¿˜ã‚Œãšã« `valgrind` ã‚‚å…¥ã‚Œã¦ãŠãã¾ã™ã€‚

## ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³
PHP ã®ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒª (git) ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãã¾ã™ã€‚ `git` ãŒå…¥ã£ã¦ã„ãªã„å ´åˆã¯ `apt` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ sudo apt-get install -y git
$ git clone -b"PHP-8.0.7" https://github.com/php/php-src.git php-src
```

## ãƒ“ãƒ«ãƒ‰
æ¬¡ã®é€šã‚Šã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚µãƒãƒ¼ãƒˆã—ãŸã„æœ€å°ã® PHP ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®éƒ¨åˆ†ã«ã¯ `PHP-8.0.7` ãªã©ã‚’æŒ‡å®šã—ã¾ã™ã€‚ `master` ã‚„ `PHP-8.0` ã¯é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒãªã®ã§ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦ã¯ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‰ãªã„å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚

`./configure` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯é©å®œèª¿æ•´ã—ã¦ãã ã•ã„ã€‚åŸºæœ¬çš„ã«ã¯ä»¥ä¸‹ã®æŒ‡å®šã§å•é¡Œã«ãªã‚‹ã“ã¨ã¯ãªã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ cd php-src
$ git checkout "ã‚µãƒãƒ¼ãƒˆã—ãŸã„æœ€å°ã® PHP ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
$ ./buildconf --force
$ ./configure --disable-fpm --disable-cgi --disable-phpdbg --enable-opcache --enable-debug --with-openssl --with-zip
$ make -j"$(nproc)"
$ sudo make install
```

# Extension ã®ä½œæˆ (åŸºæœ¬)

## é››å½¢ã®ä½œæˆ
PHP ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã¯ PHP Extension ã®é››å½¢ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¾¤ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

å…ˆç¨‹ãƒ“ãƒ«ãƒ‰ã—ãŸ PHP ã‚’åˆ©ç”¨ã—ã¦é››å½¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ `extension_name` ã¯é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```bash
$ ./sapi/cli/php ./ext/ext_skel.php --ext "extension_name"
Copying config scripts... done
Copying sources... done
Copying tests... done

Success. The extension is now ready to be compiled. To do so, use the
following steps:

cd /path/to/php-src/ext/extension_name
phpize
./configure
make

Don't forget to run tests once the compilation is done:
make test

Thank you for using PHP!
```

## ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆ
ä½œæˆã•ã‚ŒãŸé››å½¢ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã™

```bash
$ cd ./ext/extension_name
$ phpize && ./configure && make
$ make test
=====================================================================
PHP         : /usr/local/bin/php
PHP_SAPI    : cli
PHP_VERSION : 8.0.7-dev
ZEND_VERSION: 4.0.6-dev
PHP_OS      : Linux - Linux ad5f0409f143 5.10.25-linuxkit #1 SMP Tue Mar 23 09:27:39 UTC 2021 x86_64
INI actual  : /php-src/ext/extension_name/tmp-php.ini
More .INIs  :
CWD         : /php-src/ext/extension_name
Extra dirs  :
VALGRIND    : Not used
=====================================================================
TIME START 2021-06-05 12:07:32
=====================================================================
PASS Check if extension_name is loaded [tests/001.phpt]
PASS test1() Basic test [tests/002.phpt]
FAIL extension_name_test2() Basic test [tests/003.phpt]
=====================================================================
TIME END 2021-06-05 12:07:32

=====================================================================
TEST RESULT SUMMARY
---------------------------------------------------------------------
Exts skipped    :    0
Exts tested     :   28
---------------------------------------------------------------------

Number of tests :    3                 3
Tests skipped   :    0 (  0.0%) --------
Tests warned    :    0 (  0.0%) (  0.0%)
Tests failed    :    1 ( 33.3%) ( 33.3%)
Tests passed    :    2 ( 66.7%) ( 66.7%)
---------------------------------------------------------------------
Time taken      :    0 seconds
=====================================================================

=====================================================================
FAILED TEST SUMMARY
---------------------------------------------------------------------
extension_name_test2() Basic test [tests/003.phpt]
=====================================================================
```

## é–¢æ•°è¿½åŠ ãƒ»ä¿®æ­£

ä¸€ã¤ãƒ†ã‚¹ãƒˆãŒè½ã¡ã‚‹ã®ã§ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚

`extension_name.stub.php` ã‚’ç·¨é›†ã—ã€ `extension_name_test2()` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```php:extension_name.stub.php
<?php

/** @generate-function-entries */

function test1(): void {}

function test2(string $str = ""): string {}

function extension_name_test2(string $str = ""): string {}
```

è¿½è¨˜ã—ãŸã‚‰ `gen_stub.php` ã‚’åˆ©ç”¨ã—ã¦ã‚¹ã‚¿ãƒ–ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
`gen_stub.php` ã«ã¯ curl ã¾ãŸã¯ wget ãŒå¿…è¦ãªã®ã§ã€å…¥ã£ã¦ã„ãªã‘ã‚Œã°äº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚

```
$ sudo apt-get install -y curl
$ ../../build/gen_stub.php
```

æ¬¡ã« `extension_name.c` ã‚’é–‹ãã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½è¨˜ã—ã¾ã™ã€‚
ä¸­èº«ã¯ `test2` ã®ã‚³ãƒ”ãƒ¼ã§ã™ã€‚

```c:extension_name.c
/* {{{ string extension_name_test2( [ string $var ] ) */
PHP_FUNCTION(extension_name_test2)
{
        char *var = "World";
        size_t var_len = sizeof("World") - 1;
        zend_string *retval;

        ZEND_PARSE_PARAMETERS_START(0, 1)
                Z_PARAM_OPTIONAL
                Z_PARAM_STRING(var, var_len)
        ZEND_PARSE_PARAMETERS_END();

        retval = strpprintf(0, "Hello %s", var);

        RETURN_STR(retval);
}
/* }}}*/
```

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦å†åº¦ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã™ã€‚

```bash
$ make -j"$(nproc)"
$ make test

```